<% t = SciolyFF::Helper.new(data[tournament]) %>
<% events = t.events_by_name.values.sort do |a, b|
              if a[:trial] && !b[:trial] then 1
              elsif !a[:trial] && b[:trial] then -1
              else a[:name] <=> b[:name]
              end
            end %>
<% teams_by_rank = t.sort_teams_by_rank %>
<% teams_by_number = t.teams_by_number.sort.map(&:last) %>

<div class="results-classic-wrapper">
<div class="results-classic-thead-background shadow-sm"
     style="min-width: <%= 2*(events.count + 1) + 28.5 %>em;
            background-color: <%= find_bg_color(current_page.path) %>;">
  <div class="results-classic-header"
       style="width: <%= 2*(events.count + 1) + 28 %>em">
    <h1 class="display-4 mb-0">
      <%= t.tournament[:year] %>
      <%= t.tournament[:state] if t.tournament[:level] == 'States' %>
      <%= t.tournament[:level] %> Div.
      <%= t.tournament[:division] %>
    </h1>
    <p class="lead mb-2">@ <%= t.tournament[:location] %></p>
    <p><%= t.tournament[:date].strftime('%A, %B %-d, %Y') %></p>
    <div class="actions">
      <a href="/results"><i class="material-icons">arrow_back</i></a>
      <a href="#" data-toggle="modal" data-target="#download-info">
        <i class="material-icons">file_download</i>
      </a>
      <a href="#" data-toggle="modal" data-target="#print-instructions">
        <i class="material-icons">print</i>
      </a>
      <a href="#" data-toggle="modal" data-target="#team-filter">
        <i class="material-icons">filter_list</i>
      </a>
      <select id="event-select" class="custom-select custom-select-sm"
              aria-label="Select Event Filter">
        <option value="all" selected>All Events</option>
      <% events.each.with_index do |e, i| %>
        <option value="<%= i %>">
          <%= e[:name] %>
          <% if e[:trial] %>
            (Trial)
          <% elsif e[:trialed] %>
            (Trialed)
          <% end %>
        </option>
      <% end %>
      </select>
      <select id="sort-select" class="custom-select custom-select-sm"
              aria-label="Select Sort Method">
        <option value="number">by Number</option>
        <option value="school">by School</option>
        <option value="rank" selected>by Rank</option>
      </select>
      <a href="#" data-toggle="modal" data-target="#settings" class="settings">
        <i class="material-icons">settings</i>
      </a>
    </div>
    <p class="source">
      Source:
      <a href="https://unosmium.netlify.com<%= current_page.url %>">
        Unosmium Results
      </a>
    </p>
  </div>
</div>
<table class="results-classic table-hover">
<colgroup>
  <col>
  <col>
  <col>
  <col>
  <col>
</colgroup>
<colgroup class="event-columns">
<% events.count.times do %>
  <col>
<% end %>
  <col> <%# for team penalties, which kinda act like an additional event %>
</colgroup>
<thead>
  <tr>
    <th class="number">#</th>
    <th class="school">School</th>
    <th class="event-points-focus"><div></div></th>
    <th class="rank"><div>Overall</div></th>
    <th class="total-points">Total</th>
  <% events.each do |e| %>
    <th class="event-points">
      <%= e[:name] %>
    <% if e[:trial] %>
      <a tabindex="0" role="button" href="#"
         data-toggle="popover" data-trigger="focus"
         title="Trial Event"
         data-content="Placings in this event did not count towards total
                       team score">
        <span class="badge badge-info"><small>T</small></span>
      </a>
    <% elsif e[:trialed] %>
      <a tabindex="0" role="button" href="#"
         data-toggle="popover" data-trigger="focus"
         title="Trialed Event"
         data-content="Placings in this event did not count towards total
                       team score because of unforseen circumstances during
                       the competition">
        <span class="badge badge-warning"><small>Td</small></span>
      </a>
    <% end %>
    </th>
  <% end %>
  <th class="team-penalties">Team Penalties</th>
  </tr>
</thead>
<tbody>
<% teams_by_rank.each.with_index do |tm, i| %>
  <tr data-team-number="<%= tm[:number] %>">
    <td class="number"><%= tm[:number] %></td>
    <td class="school">
      <%= tm[:school] %> <small><%= tm[:state] %></small>
    <% if tm[:exhibition] %>
      <a tabindex="0" role="button" href="#"
         data-toggle="popover" data-trigger="focus"
         title="Exhibition Team"
         data-content="Placings by this team did not affect the ranks of other
                       teams (except in Trial Events)">
        <span class="badge badge-warning"><small>Ex</small></span>
    <% end %>
    </td>
    <td class="event-points-focus" data-points=""><div></div></td>
    <td class="rank" data-points="<%= i + 1 %>"><div><%= i + 1 %></div></td>
    <td class="total-points"><%= t.team_points tm[:number] %></td>
  <% events.each do |e| %>
    <% ep = t.event_points tm[:number], e[:name] %>
    <td class="event-points" data-points="<%= ep %>"><div><%= ep %></div></td>
  <% end %>
    <% points = t.team_points_from_penalties(tm[:number]) %>
    <td class="team-penalties text-muted" data-points="<%= points %>">
      <%= points.zero? ? "00" : "+#{points}" %>
    </td>
  </tr>
<% end %>
</tbody>
</table>
</div>
<div class="modal" id="team-filter" tabindex="-1" role="dialog"
     aria-labelledby="team-filter-label" aria-hidden="true">
  <div class="modal-dialog" role="form">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="team-filter-label">
          Select teams to show
        </h5>
        <button type="button" class="close" data-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true" style="vertical-align: super">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input"
                 id="allTeams" checked>
          <label class="custom-control-label" for="allTeams">
            All Teams
          </label>
        </div>
        <hr>
      <% teams_by_number.each do |tm| %>
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input"
                 id="team<%= tm[:number] %>" checked>
          <label class="custom-control-label" for="team<%= tm[:number] %>">
            <%= tm[:number] %> <%= tm[:school] %> <small><%= tm[:state] %></small>
          </label>
        </div>
      <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="print-instructions" tabindex="-1" role="dialog"
     aria-labelledby="print-instructions-label" aria-hidden="true">
  <div class="modal-dialog" role="form">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="print-instructions-label">
          Instructions for printing
        </h5>
        <button type="button" class="close" data-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true" style="vertical-align: super">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>For best results, ensure the following:</p>
        <ul>
          <li>You are using Chrome or Safari. (Sorry, Firefox users.)</li>
          <li>The printer is set to "Save as PDF", not "Microsoft Print to PDF".</li>
        </ul>
        <p class="small">
          Note: You may want to use your browser's Print Preview feature instead
          of the button below.
        </p>
        <p>
          The output will be in style of official results from the National
          competition, suitable for distributing to teams after awards.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-secondary" onclick="window.print();">
          Print
        </button>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="download-info" tabindex="-1" role="dialog"
     aria-labelledby="download-info-label" aria-hidden="true">
  <div class="modal-dialog" role="form">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="download-info-label">
          About downloading
        </h5>
        <button type="button" class="close" data-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true" style="vertical-align: super">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p>
          To download these results as a PDF, select CANCEL and see the
          instructions for printing (<i class="material-icons">print</i>)
          instead.
        </p>
        <p>
          The results will be downloaded as a YAML file, specifically in the
          SciolyFF, and can be opened with any text editor or parsed with your
          favorite programming language. For more info about SciolyFF, see
          <a href="https://github.com/unosmium/sciolyff">here</a>.
        </p>
        <p>
          If you really want a CSV file, select CANCEL, copy the whole table
          using <kbd>Ctrl+A</kbd> and <kbd>Ctrl+C</kbd>, then paste into a new
          <a href="https://docs.google.com/spreadsheets/">Google Sheets</a>
          spreadsheet and do File &gt; Download as &gt; Comma-separated values.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Cancel
        </button>
        <a role="button" class="btn btn-secondary"
           href="/data/<%= File.basename(current_page.path, '.html') + '.yaml' %>">
          Download
        </a>
      </div>
    </div>
  </div>
</div>
<div class="modal" id="settings" tabindex="-1" role="dialog"
     aria-labelledby="settings-label" aria-hidden="true">
  <div class="modal-dialog" role="form">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="settings-label">
          Settings
        </h5>
        <button type="button" class="close" data-dismiss="modal"
                aria-label="Close">
          <span aria-hidden="true" style="vertical-align: super">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <h6>Select which medals to highlight</h6>
      <% (1..6).each do |x| %>
        <div class="custom-control custom-checkbox">
          <input type="checkbox" class="custom-control-input"
                 id="medal<%= x %>" checked>
          <label class="custom-control-label" for="medal<%= x %>">
            <% suffix =  case x
                         when 1 then 'st'
                         when 2 then 'nd'
                         when 3 then 'rd'
                         when 4..6 then 'th'
                         end %>
            <%= x %><sup><%= suffix %></sup> place medals
          </label>
        </div>
      <% end %>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">
          Close
        </button>
      </div>
    </div>
  </div>
</div>
